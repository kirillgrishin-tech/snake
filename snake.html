<html>
<head>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="border" id = "ALL"></div>
<div class="buttons">
    <button id="easy" onclick="EasyStart()">Простой</button>
    <button id="medium" onclick="MediumStart()">Средний</button>
    <button id="hard" onclick="HardStart()">Сложный</button>
    <button onclick="reload()">Обновить</button>
</div>
<div class = score>Ваш счет: 0</div>
<script type="text/javascript">
  
  window.addEventListener('load', function(){
    
      let touchsurface = document.getElementById('ALL'),
          startX,
          startY,
          distX,
          distY,
          swipedir,
          threshold = 150, // минимальное расстояние для swipe
          allowedTime = 200, // максимальное время прохождения установленного расстояния
          elapsedTime,
          startTime
    
      touchsurface.addEventListener('touchstart', function(e){
          touchsurface.innerHTML = ''
          let touchobj = e.changedTouches[0]
          let dist = 0
          startX = touchobj.pageX
          startY = touchobj.pageY
          startTime = new Date().getTime() // время контакта с поверхностью сенсора
          e.preventDefault()
      }, false)
    
      touchsurface.addEventListener('touchmove', function(e){
          e.preventDefault() // отключаем стандартную реакцию скроллинга
      }, false)
    
      touchsurface.addEventListener('touchend', function(e){
          let touchobj = e.changedTouches[0]
          distX = touchobj.pageX - startX // получаем пройденную дистанцию
          distY = touchobj.pageY - startY
          elapsedTime = new Date().getTime() - startTime // узнаем пройденное время
          // проверяем затраченное время,горизонтальное перемещение >= threshold, и вертикальное перемещение <= 100
          if (elapsedTime <= allowedTime){
            if (Math.abs(distX) >= threshold && Math.abs(distY) <= 100){
						swipedir = (distX < 0)? 'left' : 'right'
					}
					else if (Math.abs(distY) >= threshold  && Math.abs(distX) <= 100){
						swipedir = (distY < 0)? 'up' : 'down'
					}
          }
          handleswipe(swipedir)
          e.preventDefault()
      }, false)
    
  }, false)

  function handleswipe(swipe){
        switch (swipe){
            case 'left':
                if (direct != 0){
                    directx = 2;
                }
                break;

            case 'right':
                if (direct != 2){
                    directx = 0;
                }
                break;

            case 'up':
                if (direct != 1){
                    directx = 3;
                }
                break;

            case 'down':
                if (direct != 3){
                    directx = 1;
                }
                break;
        }

      }

    snmv = false;
    let brd = document.getElementsByClassName("border");
    let timer;
    let directx = direct = 0;
    let fieldSizeX = Math.round(brd[0].clientHeight*0.8/(brd[0].clientHeight*0.05));
    let fieldSizeY = Math.round(brd[0].clientWidth*0.70/(brd[0].clientHeight*0.05));
    let KEY = {
        'left' : 37,
        'up' : 38,
        'right' : 39,
        'down' : 40
    };

    let direction = [
        [0,1],
        [1,0],
        [0,-1],
        [-1,0]];

    let snake = {
        length : 3,
        body : [[1,1],[1,2],[1,3]],
        initialisationSnake : function (){
            for ( let i = 0; i < this.length; i++){
                let currentBodyPart = this.body[i];
                document.getElementById(currentBodyPart.join()).className = 'cell snake';
            }
        },
        move : function (){
            direct = directx;
            snmv = true;
            let body = this.body
            let head = this.body[this.length-1];
            let headCell = head.map(function(value, index){ return value + direction[direct][index] });
            compareEatOrGameOver(headCell, body);
            return headCell;
        }
    };

    window.addEventListener('keydown', keyHandler, false);
    prepareGamePane(fieldSizeX, fieldSizeY);


    function prepareGamePane (fieldSizeX, fieldSizeY){
        let rt = 12;
        for ( let x = 0; x < fieldSizeX; x++){
            let coordinateX = document.createElement('div');
            document.body.appendChild(coordinateX);
            coordinateX.className = 'field';
            coordinateX.style = "top: "+(rt+x*5)+"%";
            for (let y = 0; y < fieldSizeY; y++){
                let coordinateY = document.createElement('div');
                coordinateX.appendChild(coordinateY);
                coordinateY.className = 'cell';
                coordinateY.id = x+','+y;
                coordinateY.style = "width: "+coordinateY.clientHeight;
            }
        }
        setInterval(function(){
            let ys = document.getElementsByClassName("cell");
            for(let y=0; y<ys.length; y++){
                ys[y].style = "width: "+ys[y].clientHeight}
        },50);
        snake.initialisationSnake();
        makeFood(fieldSizeX, fieldSizeY);
    }

    function makeFood (fieldSizeX, fieldSizeY){
        let x = Math.round(Math.random() * (fieldSizeX-1));
        let y = Math.round(Math.random() * (fieldSizeY-1));
        let food = document.getElementById(x+','+y);
        if (food.className == 'cell'){
            food.className = "cell food";
        } else { 
            makeFood(fieldSizeX, fieldSizeY);
        }
        return food;
    }


    function keyHandler (event){
        switch (event.keyCode) {
            case KEY.left:
                if (direct != 0){
                    directx = 2;
                }
                break;

            case 65:
                if (direct != 0){
                    directx = 2;
                }
                break;

            case KEY.right:
                if (direct != 2){
                    directx = 0;
                }
                break;
            
            case 68:
                if (direct != 2){
                    directx = 0;
                }
                break;

            case KEY.up:
                if (direct != 1){
                    directx = 3;
                }
                break;

            case 87:
                if (direct != 1){
                    directx = 3;
                }
                break;

            case KEY.down:
                if (direct != 3){
                    directx = 1;
                }
                break;

            case 83:
                if (direct != 3){
                    directx = 1;
                }
                break;

            default :
                return;
        }
    }
    function dirx(id){
        switch (id) {
            case "left":
                if (direct != 0){
                    directx = 2;
                }
                break;

            case "right":
                if (direct != 2){
                    directx = 0;
                }
                break;

            case "up":
                if (direct != 1){
                    directx = 3;
                }
                break;

            case "down":
                if (direct != 3){
                    directx = 1;
                }
                break;

            default :
                return;
        }
    }

    function compareEatOrGameOver (headCell, body) {
        let tmp = document.getElementById(headCell.join());
        if (tmp == null ) {
          if (headCell[0] == -1)
            headCell[0] = fieldSizeX - 1;
          if (headCell[0] == fieldSizeX)
            headCell[0] = 0;
          if (headCell[1] == -1)
            headCell[1] = fieldSizeY - 1;
          if (headCell[1] == fieldSizeY)
            headCell[1] = 0;
          tmp = document.getElementById(headCell.join());
        }

        if ( tmp != null && tmp.className == 'cell' ){
            let removeTail = body.shift();
            body.push(headCell);
            document.getElementById(removeTail.join()).className = 'cell';
            document.getElementById(headCell.join()).className = 'cell snake';
        } else { 
            if ( tmp != null && tmp.className == 'cell food'){
                snake.length++;
                let scor = document.querySelector('.score');
                scor.innerHTML = 'Ваш счет: '+ (snake.length-3);
                body.push(headCell);
                document.getElementById(headCell.join()).className = 'cell snake';
                makeFood(fieldSizeX, fieldSizeY);
            } else { 
                if (tmp.className == 'cell snake'){
                    clearInterval(timer);
                    alert('Вы проиграли! Ваш счет: ' + (snake.length-3) + '. Нажмите кнопку «Обновить» для начала новой игры!');
                }
            }
        }
    }

    function EasyStart () {
        if (snmv ==false){
        timer = setInterval(function(){
            snake.move();
        },300);}
    }
    function MediumStart () {
        if (snmv ==false){
        timer = setInterval(function(){
            snake.move();
        },200);}
    }
    function HardStart () 
    {
        if (snmv ==false){
        timer = setInterval(function(){
            snake.move();
        },100);}
    }

    function reload () 
    {
        window.location.reload();
    }
</script>